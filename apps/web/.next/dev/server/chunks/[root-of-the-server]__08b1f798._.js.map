{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///Volumes/WADEOW/PROYECTOS/LibroWeb/codigoLibroWeb/apps/web/app/api/payment/route.js"],"sourcesContent":["import axios from 'axios';\n\nexport async function POST(request) {\n  try {\n    const { physical, digital, total, orderId } = await request.json();\n\n    // Validar que haya productos\n    if (!orderId || (physical === 0 && digital === 0)) {\n      return Response.json(\n        { error: 'Datos de orden inválidos' },\n        { status: 400 }\n      );\n    }\n\n    // Crear items para la preferencia\n    const items = [];\n    \n    if (physical > 0) {\n      items.push({\n        id: 'book-physical',\n        title: 'Libro Físico',\n        description: `${physical} unidad(es) - Envío incluido`,\n        quantity: physical,\n        currency_id: 'MXN',\n        unit_price: 20\n      });\n    }\n\n    if (digital > 0) {\n      items.push({\n        id: 'book-digital',\n        title: 'Libro Digital',\n        description: `${digital} unidad(es) - Descarga inmediata`,\n        quantity: digital,\n        currency_id: 'MXN',\n        unit_price: 10\n      });\n    }\n\n    // Crear la preferencia de pago\n    const preference = {\n      items: items,\n      back_urls: {\n        success: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/checkout/redirect?type=success&orderId=${orderId}`,\n        failure: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/checkout/redirect?type=failure&orderId=${orderId}`,\n        pending: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/checkout/redirect?type=pending&orderId=${orderId}`\n      },\n      notification_url: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/payment/webhook`,\n      external_reference: orderId,\n      statement_descriptor: 'LibroWeb',\n      binary_mode: true\n    };\n\n    // Crear preferencia usando la API de Mercado Pago\n    console.log('Creando preferencia con token:', process.env.MERCADO_PAGO_ACCESS_TOKEN?.substring(0, 20) + '...');\n    console.log('Preference data:', JSON.stringify(preference, null, 2));\n    \n    const response = await axios.post(\n      'https://api.mercadopago.com/checkout/preferences',\n      preference,\n      {\n        headers: {\n          'Authorization': `Bearer ${process.env.MERCADO_PAGO_ACCESS_TOKEN}`,\n          'Content-Type': 'application/json'\n        }\n      }\n    );\n\n    console.log('Respuesta MP:', response.data);\n    \n    return Response.json({\n      id: response.data.id,\n      init_point: response.data.init_point,\n      sandbox_init_point: response.data.sandbox_init_point\n    });\n  } catch (error) {\n    console.error('=== ERROR EN /api/payment ===');\n    console.error('Mensaje:', error.message);\n    console.error('Status:', error.response?.status);\n    console.error('Data:', error.response?.data);\n    console.error('Full error:', error);\n    \n    return Response.json(\n      { \n        error: error.response?.data?.message || error.message || 'Error al procesar el pago',\n        details: error.response?.data || {}\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEhE,6BAA6B;QAC7B,IAAI,CAAC,WAAY,aAAa,KAAK,YAAY,GAAI;YACjD,OAAO,SAAS,IAAI,CAClB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,kCAAkC;QAClC,MAAM,QAAQ,EAAE;QAEhB,IAAI,WAAW,GAAG;YAChB,MAAM,IAAI,CAAC;gBACT,IAAI;gBACJ,OAAO;gBACP,aAAa,GAAG,SAAS,4BAA4B,CAAC;gBACtD,UAAU;gBACV,aAAa;gBACb,YAAY;YACd;QACF;QAEA,IAAI,UAAU,GAAG;YACf,MAAM,IAAI,CAAC;gBACT,IAAI;gBACJ,OAAO;gBACP,aAAa,GAAG,QAAQ,gCAAgC,CAAC;gBACzD,UAAU;gBACV,aAAa;gBACb,YAAY;YACd;QACF;QAEA,+BAA+B;QAC/B,MAAM,aAAa;YACjB,OAAO;YACP,WAAW;gBACT,SAAS,GAAG,6DAAmC,wBAAwB,wCAAwC,EAAE,SAAS;gBAC1H,SAAS,GAAG,6DAAmC,wBAAwB,wCAAwC,EAAE,SAAS;gBAC1H,SAAS,GAAG,6DAAmC,wBAAwB,wCAAwC,EAAE,SAAS;YAC5H;YACA,kBAAkB,GAAG,6DAAmC,wBAAwB,oBAAoB,CAAC;YACrG,oBAAoB;YACpB,sBAAsB;YACtB,aAAa;QACf;QAEA,kDAAkD;QAClD,QAAQ,GAAG,CAAC,kCAAkC,QAAQ,GAAG,CAAC,yBAAyB,EAAE,UAAU,GAAG,MAAM;QACxG,QAAQ,GAAG,CAAC,oBAAoB,KAAK,SAAS,CAAC,YAAY,MAAM;QAEjE,MAAM,WAAW,MAAM,kJAAK,CAAC,IAAI,CAC/B,oDACA,YACA;YACE,SAAS;gBACP,iBAAiB,CAAC,OAAO,EAAE,QAAQ,GAAG,CAAC,yBAAyB,EAAE;gBAClE,gBAAgB;YAClB;QACF;QAGF,QAAQ,GAAG,CAAC,iBAAiB,SAAS,IAAI;QAE1C,OAAO,SAAS,IAAI,CAAC;YACnB,IAAI,SAAS,IAAI,CAAC,EAAE;YACpB,YAAY,SAAS,IAAI,CAAC,UAAU;YACpC,oBAAoB,SAAS,IAAI,CAAC,kBAAkB;QACtD;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,QAAQ,KAAK,CAAC,YAAY,MAAM,OAAO;QACvC,QAAQ,KAAK,CAAC,WAAW,MAAM,QAAQ,EAAE;QACzC,QAAQ,KAAK,CAAC,SAAS,MAAM,QAAQ,EAAE;QACvC,QAAQ,KAAK,CAAC,eAAe;QAE7B,OAAO,SAAS,IAAI,CAClB;YACE,OAAO,MAAM,QAAQ,EAAE,MAAM,WAAW,MAAM,OAAO,IAAI;YACzD,SAAS,MAAM,QAAQ,EAAE,QAAQ,CAAC;QACpC,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}